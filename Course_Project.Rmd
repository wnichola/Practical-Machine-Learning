---
title: "Practical Machine Learning: Course Project"
author: "Nicholas Wee"
date: "Saturday, June 13, 2015"
output:
  html_document:
    keep_md: yes
---

## Download and load files into data.tables
Check if the file exists.  If not, download it from the URL.  When reading in the file, change invalid values to NA.  

```{r}
library(caret)
setInternet2(TRUE)
setwd("C:/Data/My Project/MOCC/03 Quiz and Projects/08 Machine Learning")

target <- "pml_training.csv"
if (!file.exists(target)) {
    url <-
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
    target <- "pml_training.csv"
    download.file(url, destfile = target)
}
training <- read.csv(target, na.strings = c("NA","#DIV/0!",""))

target <- "pml_testing.csv"
if (!file.exists(target)) {
    url <-
        "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
    download.file(url, destfile = target)
}
testing <- read.csv(target, na.strings = c("NA","#DIV/0!",""))
```

## Remove invalid predictors
Reduce the number of predictors by removing columns that have near zero values, NA, or is empty.

```{r}
# Remove columns with Near Zero Values
subTrain <-
    training[, names(training)[!(nzv(training, saveMetrics = T)[, 4])]]

# Remove columns with NA or is empty
subTrain <-
    subTrain[, names(subTrain)[sapply(subTrain, function (x)
        ! (any(is.na(x) | x == "")))]]


# Remove V1 which seems to be a serial number, and
# cvtd_timestamp that is unlikely to influence the prediction
subTrain <- subTrain[,-1]
subTrain <- subTrain[, c(1:3, 5:58)]
```
## Separate the data to be used for Cross Validation
Using the training data, separate out a set to be used for validation.

```{r}
# Divide the training data into a training set and a validation set
inTrain <- createDataPartition(subTrain$classe, p = 0.6, list = FALSE)
subTraining <- subTrain[inTrain,]
subValidation <- subTrain[-inTrain,]
```

## Create the prediction model (using rainforest)
Using the first set of data, to create the prediction model (using rainforest).  

Because of the CPU resources required, first, setup to run it in Parallel, using all the CPU cores available...as advised by Course Forum.  Also, even with it running on multiple cores, it will take a long time to create the prediction model. As such, load the model from a previous good run by checking if the model file exists.  
  
```{r}
# Check if model file exists
model <- "modelFit.RData"
if (!file.exists(model)) {

    # If not, set up the parallel clusters.  
    require(parallel)
    require(doParallel)
    cl <- makeCluster(detectCores() - 1)
    registerDoParallel(cl)
    
    fit <- train(subTraining$classe ~ ., method = "rf", data = subTraining)
    save(fit, file = "modelFit.RData")
    
    stopCluster(cl)
} else {
    # Good model exists from previous run, load it and use it.  
    load(file = "modelFit.RData", verbose = TRUE)
}
```

## Measure the accuracy of the prediction model
Using the training subset and create a prediction.  Then measure it's accuracy

```{r}
predTrain <- predict(fit, subTraining)
confusionMatrix(predTrain, subTraining$classe)
```

Using the validation subset and create a prediction.  Then measure it's accuracy.  From the training subset, the accuracy is very high, at above 99%.

```{r}
predTest <- predict(fit, subValidation)
confusionMatrix(predTest, subValidation$classe)
```

From the validation subset, the accuracy is still very high, at above 99%. From the model, the following are the list of important predictors in the model.  The OOB Estimate Error create is found in the model.

```{r}
varImp(fit)
fit$finalModel
```

Though the accuracy is high, the OOB estimated error is also quite high at 12%.  But the class error is sufficiently low to allow the model to be used for prediction.

## Apply the prediction model
Apply the prediction model to the testing data.  And generate the files for submission with the given R code from the assignment.

```{r}
predTesting <- predict(fit, testing)

pml_write_files = function(x){
    n = length(x)
    for(i in 1:n){
        filename = paste0("problem_id_",i,".txt")
        write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
    }
}

pml_write_files(predTesting)
```